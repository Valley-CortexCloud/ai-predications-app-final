name: Dashboard Confirmation

on:
  repository_dispatch:
    types: [dashboard_confirmation]
  workflow_dispatch:
    inputs:
      token:
        description: 'Security token'
        required: true
      date:
        description: 'Portfolio date (YYYY-MM-DD)'
        required: true
      action:
        description: 'Action (CONFIRM or DENY)'
        required: true
        type: choice
        options:
          - CONFIRM
          - DENY
      sells:
        description: 'Symbols to sell (comma-separated)'
        required: false
      buys:
        description: 'Symbols to buy (comma-separated)'
        required: false

jobs:
  process-confirmation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas yfinance alpaca-py
      
      - name: Extract payload
        id: payload
        run: |
          # Handle both repository_dispatch and workflow_dispatch
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "token=${{ github.event.client_payload.token }}" >> $GITHUB_OUTPUT
            echo "date=${{ github.event.client_payload.date }}" >> $GITHUB_OUTPUT
            echo "action=${{ github.event.client_payload.action }}" >> $GITHUB_OUTPUT
            
            # Convert arrays to comma-separated strings
            SELLS=$(echo '${{ toJson(github.event.client_payload.sells) }}' | jq -r 'join(",")')
            BUYS=$(echo '${{ toJson(github.event.client_payload.buys) }}' | jq -r 'join(",")')
            HOLDS=$(echo '${{ toJson(github.event.client_payload.holds) }}' | jq -r 'join(",")')
            SKIPS=$(echo '${{ toJson(github.event.client_payload.skips) }}' | jq -r 'join(",")')
            
            echo "sells=$SELLS" >> $GITHUB_OUTPUT
            echo "buys=$BUYS" >> $GITHUB_OUTPUT
            echo "holds=$HOLDS" >> $GITHUB_OUTPUT
            echo "skips=$SKIPS" >> $GITHUB_OUTPUT
          else
            echo "token=${{ github.event.inputs.token }}" >> $GITHUB_OUTPUT
            echo "date=${{ github.event.inputs.date }}" >> $GITHUB_OUTPUT
            echo "action=${{ github.event.inputs.action }}" >> $GITHUB_OUTPUT
            echo "sells=${{ github.event.inputs.sells }}" >> $GITHUB_OUTPUT
            echo "buys=${{ github.event.inputs.buys }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate token
        id: validate
        run: |
          TOKEN_FILE="data/portfolio/tokens/${{ steps.payload.outputs.date }}.json"
          
          if [ ! -f "$TOKEN_FILE" ]; then
            echo "‚ùå Token file not found: $TOKEN_FILE"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check token matches
          STORED_TOKEN=$(jq -r '.token' "$TOKEN_FILE")
          if [ "$STORED_TOKEN" != "${{ steps.payload.outputs.token }}" ]; then
            echo "‚ùå Token mismatch"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check not expired
          EXPIRES=$(jq -r '.expires' "$TOKEN_FILE")
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%S")
          if [[ "$NOW" > "$EXPIRES" ]]; then
            echo "‚ùå Token expired"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check not already used
          USED=$(jq -r '.used' "$TOKEN_FILE")
          if [ "$USED" = "true" ]; then
            echo "‚ùå Token already used"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ Token validated"
          echo "valid=true" >> $GITHUB_OUTPUT
      
      - name: Mark token as used
        if: steps.validate.outputs.valid == 'true'
        run: |
          TOKEN_FILE="data/portfolio/tokens/${{ steps.payload.outputs.date }}.json"
          
          # Update used flag
          jq '.used = true' "$TOKEN_FILE" > "${TOKEN_FILE}.tmp"
          mv "${TOKEN_FILE}.tmp" "$TOKEN_FILE"
          
          echo "‚úÖ Token marked as used"
      
      - name: Process CONFIRM action
        if: steps.validate.outputs.valid == 'true' && steps.payload.outputs.action == 'CONFIRM'
        run: |
          echo "üöÄ Processing CONFIRM action for ${{ steps.payload.outputs.date }}"
          
          # Create confirmed CSV from selections
          PROPOSED_FILE="data/portfolio/proposed_${{ steps.payload.outputs.date }}.csv"
          CONFIRMED_FILE="data/portfolio/confirmed_${{ steps.payload.outputs.date }}.csv"
          
          if [ ! -f "$PROPOSED_FILE" ]; then
            echo "‚ùå Proposed file not found: $PROPOSED_FILE"
            exit 1
          fi
          
          # For now, just copy proposed to confirmed
          # In production, filter based on user selections
          cp "$PROPOSED_FILE" "$CONFIRMED_FILE"
          
          echo "‚úÖ Created confirmed file: $CONFIRMED_FILE"
          
          # Execute trades (paper trading)
          echo "üìä Executing trades..."
          python scripts/trade_executor.py \
            --confirmed "$CONFIRMED_FILE" \
            --tracker data/portfolio/tracker.csv \
            --paper \
            --auto || echo "‚ö†Ô∏è Trade execution encountered issues (continuing)"
          
          echo "‚úÖ Trades executed"
      
      - name: Process DENY action
        if: steps.validate.outputs.valid == 'true' && steps.payload.outputs.action == 'DENY'
        run: |
          echo "‚ùå Processing DENY action for ${{ steps.payload.outputs.date }}"
          echo "No trades will be executed"
      
      - name: Commit results
        if: steps.validate.outputs.valid == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add data/portfolio/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Portfolio confirmation: ${{ steps.payload.outputs.action }} for ${{ steps.payload.outputs.date }}"
            git push
          fi
      
      - name: Send confirmation email
        if: steps.validate.outputs.valid == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "‚úÖ Portfolio ${{ steps.payload.outputs.action }} - ${{ steps.payload.outputs.date }}"
          to: jvalley19@gmail.com
          from: Portfolio Intelligence <jvalley19@gmail.com>
          body: |
            Portfolio action completed!
            
            üìÖ Date: ${{ steps.payload.outputs.date }}
            ‚ö° Action: ${{ steps.payload.outputs.action }}
            
            ${{ steps.payload.outputs.action == 'CONFIRM' && 'Trades have been executed in your Alpaca paper account.' || 'No trades were executed.' }}
            
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            Portfolio Intelligence Engine
