name: Earnings Staleness Validator

on:
  schedule:
    - cron: '0 2 * * 0'  # Sunday 2 AM UTC
  workflow_dispatch:
    inputs:
      stale_days:
        description: 'Days threshold for staleness'
        default: '90'
      min_quarters:
        description: 'Minimum quarters required'
        default: '6'

permissions:
  contents: write  # Changed from 'read' to 'write' for committing

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      stale_count: ${{ steps.validate.outputs.stale_count }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install pandas
      
      - name: Validate earnings staleness
        id: validate
        run: |
          python scripts/validate_earnings_staleness.py \
            --earnings data/earnings.csv \
            --universe config/ticker_universe.csv \
            --stale-days ${{ inputs.stale_days || '90' }} \
            --min-quarters ${{ inputs.min_quarters || '6' }} \
            --output stale_tickers.txt \
            --verbose
          
          STALE_COUNT=$(wc -l < stale_tickers.txt | tr -d ' ')
          echo "stale_count=$STALE_COUNT" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Found $STALE_COUNT stale tickers"
      
      - name: Commit stale tickers list to repo
        run: |
          if [ -s stale_tickers.txt ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # Create cache directory if it doesn't exist
            mkdir -p data/cache
            
            # Move stale tickers to cache directory
            cp stale_tickers.txt data/cache/stale_tickers.txt
            
            # Add timestamp for debugging
            echo "# Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)" > data/cache/stale_tickers_metadata.txt
            echo "# Stale count: ${{ steps.validate.outputs.stale_count }}" >> data/cache/stale_tickers_metadata.txt
            echo "# Stale threshold: ${{ inputs.stale_days || '90' }} days" >> data/cache/stale_tickers_metadata.txt
            
            git add data/cache/stale_tickers.txt data/cache/stale_tickers_metadata.txt
            
            if ! git diff --staged --quiet; then
              git commit -m "chore: update stale tickers list (${{ steps.validate.outputs.stale_count }} tickers)"
              git push
              echo "âœ… Committed stale tickers list to data/cache/"
            else
              echo "â„¹ï¸ No changes to stale tickers list"
            fi
          else
            echo "âš ï¸ No stale tickers found - nothing to commit"
          fi
      
      - name: Summary
        run: |
          echo "## ðŸ“Š Earnings Staleness Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Stale tickers found:** ${{ steps.validate.outputs.stale_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -s stale_tickers.txt ]; then
            echo "### Stale Tickers (first 50):" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 stale_tickers.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
