name: Update Universe & Earnings

on:
  schedule:
    # Run every Sunday at 3 AM UTC (before weekly earnings update)
    - cron: '0 3 * * 0'
  
  workflow_dispatch: 
    inputs:
      mode:
        description: 'Update mode'
        required: false
        type: choice
        options: 
          - incremental
          - full
        default: 'incremental'
      
      skip_universe: 
        description: 'Skip ticker universe update'
        required: false
        type: boolean
        default: false

jobs:
  update-all: 
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Free up disk space
        run: |
          echo "Before cleanup:"
          df -h /
          
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/. ghcup
          sudo docker image prune -a -f
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          
          echo "After cleanup:"
          df -h /
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install --upgrade yfinance requests-cache
      
      # ============================================================
      # STEP 1: Update Ticker Universe
      # ============================================================
      - name:  Fetch ticker universe
        if: ${{ ! inputs.skip_universe }}
        run: |
          echo "ðŸ” Fetching ticker universe from Wikipedia..."
          python3 scripts/fetch_ticker_universe.py
      
      - name:  Commit ticker universe if changed
        if: ${{ ! inputs.skip_universe }}
        run: |
          if git diff --quiet config/ticker_universe.csv; then
            echo "No changes to ticker universe"
            echo "universe_changed=false" >> $GITHUB_ENV
          else
            echo "universe_changed=true" >> $GITHUB_ENV
            
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add config/ticker_universe.csv
            
            TICKERS=$(tail -n +2 config/ticker_universe.csv | wc -l)
            DATE=$(date -u +%Y-%m-%d)
            
            git commit -m "chore: update ticker universe" \
                       -m "" \
                       -m "- Total tickers: $TICKERS" \
                       -m "- Updated: $DATE" \
                       -m "- Sources: S&P 500, NASDAQ 100"
            
            git push
          fi
      
      
      # ============================================================
      # STEP 2: Generate Sector Map (uses ticker_universe.csv)
      # ============================================================
      - name:  Generate sector map
        env:
          # Optional: add API keys if you have premium data sources
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        run: |
          echo "ðŸ¢ Generating sector map from ticker universe..."
          python3 scripts/build_sector_map.py \
            --out config/sector_map.csv \
            --symbols-file config/ticker_universe. csv \
            --cache-requests \
            --with-heuristics
      
      - name: Commit sector map if changed
        run: |
          if git diff --quiet config/sector_map.csv; then
            echo "No changes to sector map"
            echo "sector_changed=false" >> $GITHUB_ENV
          else
            echo "sector_changed=true" >> $GITHUB_ENV
            
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add config/sector_map. csv
            
            MAPPED=$(tail -n +2 config/sector_map.csv | wc -l)
            GICS=$(tail -n +2 config/sector_map.csv | cut -d',' -f3 | grep -c "gics" || true)
            
            DATE=$(date -u +%Y-%m-%d)
            
            git commit -m "chore:  update sector map" \
                       -m "" \
                       -m "- Total mapped: $MAPPED" \
                       -m "- GICS (S&P 500): $GICS" \
                       -m "- Updated: $DATE"
            
            git push
          fi
      
      
      # ============================================================
      # STEP 3: Update Earnings Calendar (uses ticker_universe.csv)
      # ============================================================
      - name:  Determine earnings lookback
        id: earnings_lookback
        run: |
          if [ "${{ inputs.mode }}" == "full" ] || [ !  -f data/earnings. csv ]; then
            LOOKBACK="1095"
            echo "Full rebuild mode:  $LOOKBACK days (~3 years)"
          else
            LOOKBACK="180"
            echo "Incremental mode: $LOOKBACK days (~6 months)"
          fi
          echo "days=$LOOKBACK" >> $GITHUB_OUTPUT
      
      - name: Update earnings calendar
        env:
          FINNHUB_API_KEY: ${{ secrets. FINNHUB_API_KEY }}
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          ALPHAVANTAGE_API_KEY:  ${{ secrets.ALPHAVANTAGE_API_KEY }}
        run: |
          echo "ðŸ“Š Updating earnings calendar..."
          python3 scripts/update_earnings_incremental.py \
            --existing data/earnings.csv \
            --output data/earnings. csv \
            --ticker-universe config/ticker_universe. csv \
            --lookback-days ${{ steps.earnings_lookback.outputs.days }} \
            --provider-order yahoo,finnhub,fmp,alphavantage \
            --verbose
      
      - name:  Commit earnings if changed
        run: |
          if git diff --quiet data/earnings.csv; then
            echo "No changes to earnings calendar"
            echo "earnings_changed=false" >> $GITHUB_ENV
          else
            echo "earnings_changed=true" >> $GITHUB_ENV
            
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add data/earnings.csv
            
            ROWS=$(wc -l < data/earnings. csv)
            SYMBOLS=$(tail -n +2 data/earnings.csv | cut -d',' -f1 | sort -u | wc -l)
            DATE=$(date -u +%Y-%m-%d)
            
            git commit -m "chore:  update earnings calendar" \
                       -m "" \
                       -m "- Total rows: $ROWS" \
                       -m "- Symbols: $SYMBOLS" \
                       -m "- Lookback: $LOOKBACK days" \
                       -m "- Updated: $DATE" \
                       -m "- Source: Yahoo Finance (primary)"
            
            git push
          fi
      # ============================================================
      # Summary
      # ============================================================
      - name: Summary
        run: |
          echo "## ðŸŽ¯ Universe & Data Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Ticker Universe
          if [ -f config/ticker_universe.csv ]; then
            TICKERS=$(tail -n +2 config/ticker_universe.csv | wc -l)
            if [ "${{ env.universe_changed }}" == "true" ]; then
              echo "### âœ… Ticker Universe Updated" >> $GITHUB_STEP_SUMMARY
            else
              echo "### â„¹ï¸ Ticker Universe (No Changes)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "- Total tickers: **$TICKERS**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Sector Map
          if [ -f config/sector_map.csv ]; then
            MAPPED=$(tail -n +2 config/sector_map.csv | wc -l)
            if [ "${{ env.sector_changed }}" == "true" ]; then
              echo "### âœ… Sector Map Updated" >> $GITHUB_STEP_SUMMARY
            else
              echo "### â„¹ï¸ Sector Map (No Changes)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "- Mapped symbols: **$MAPPED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Earnings
          if [ -f data/earnings.csv ]; then
            ROWS=$(wc -l < data/earnings.csv)
            SYMBOLS=$(tail -n +2 data/earnings.csv | cut -d',' -f1 | sort -u | wc -l)
            OLDEST=$(tail -n +2 data/earnings.csv | cut -d',' -f2 | sort | head -1)
            NEWEST=$(tail -n +2 data/earnings.csv | cut -d',' -f2 | sort | tail -1)
            
            if [ "${{ env.earnings_changed }}" == "true" ]; then
              echo "### âœ… Earnings Calendar Updated" >> $GITHUB_STEP_SUMMARY
            else
              echo "### â„¹ï¸ Earnings Calendar (No Changes)" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "- Total events: **$ROWS**" >> $GITHUB_STEP_SUMMARY
            echo "- Symbols covered: **$SYMBOLS**" >> $GITHUB_STEP_SUMMARY
            echo "- Date range: $OLDEST to $NEWEST" >> $GITHUB_STEP_SUMMARY
          fi
